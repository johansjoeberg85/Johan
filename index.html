<!-- Chosen Palette: Dark Mode / Deep Purple Accent (Baserat p√• Tailwind CSS: Gray-800/700/600 f√∂r bakgrund, Purple-500/600 f√∂r accent.) -->
<!-- Application Structure Plan: Applikationen √§r ett interaktivt quiz i ett enda f√∂nster, designat f√∂r att vara pedagogiskt och engagerande. Huvudstrukturen √§r en "Karta" (Main Screen) d√§r anv√§ndaren v√§ljer bland fyra tematiska niv√•er. Efter att ha valt niv√•, byter appen till ett "Spelomr√•de" (Game Area) med fr√•gor, feedback och en progressiv visning av samlade "st√∂dord" (key takeaways). Denna interaktiva struktur valdes f√∂r att maximera inl√§rning och f√∂rst√•else. -->
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√§ttsprocessen Quiz: Jakten p√• R√§ttvisan</title>
    <!-- Ladda Tailwind CSS f√∂r enkel och responsiv styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Anpassad bakgrund och font */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #030712 100%);
            color: #d1d5db;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Anpassad styling f√∂r kort och interaktiva element */
        .card {
            background-color: #374151;
            border: 2px solid #6b7280;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.5);
            border-color: #a78bfa; /* Lila hoverf√§rg */
        }
        .locked {
            filter: grayscale(80%);
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none; /* Inaktivera klick p√• l√•sta niv√•er */
        }
        .unlocked {
            animation: pulse-border 1.5s infinite;
        }
        .cleared-level {
            border-color: #10b981 !important; /* Gr√∂n kant f√∂r klarad niv√• */
            filter: none;
            cursor: pointer;
            animation: none;
        }

        /* CSS-animation f√∂r att indikera ol√•st niv√• */
        @keyframes pulse-border {
            0% { border-color: #4b5563; }
            50% { border-color: #a78bfa; }
            100% { border-color: #4b5563; }
        }

        .correct-answer {
            background-color: #10b981; /* Gr√∂n f√∂r r√§tt svar */
            color: white;
            animation: flash-correct 0.5s ease-in-out;
        }
        .wrong-answer {
            background-color: #ef4444; /* R√∂d f√∂r fel svar */
            color: white;
            animation: shake 0.3s;
        }

        /* CSS-animationer */
        @keyframes flash-correct {
            0%, 100% { background-color: #10b981; }
            50% { background-color: #059669; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

<div id="app" class="p-4 md:p-8 w-full max-w-4xl">
    <!-- Huvudsk√§rm f√∂r spelet -->
    <div id="main-screen" class="space-y-6">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white text-center mb-6 drop-shadow-lg">
            R√§ttsprocessen Quiz: Jakten p√• R√§ttvisan
        </h1>
        <p class="text-center text-lg md:text-xl text-gray-300 mb-8">
            V√§lkommen! Klicka p√• √§mnena f√∂r att testa dina kunskaper och samla st√∂dord.
        </p>

        <!-- Niv√•v√§ljare (Klickbara kort) -->
        <div id="level-selection" class="grid grid-cols-2 gap-4 md:grid-cols-4 md:gap-6">
            <!-- Niv√• 1: F√∂runders√∂kning och √Öklagaren -->
            <div id="level-1" data-level="1" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 unlocked relative">
                <span class="text-3xl mb-2">üö®</span>
                <p class="font-bold text-lg">F√∂runders√∂kning & √Öklagaren</p>
                <span id="level-progress-1" class="level-progress-display absolute top-2 right-2 text-sm font-bold bg-purple-600 text-white px-2 py-0.5 rounded-full">0%</span>
            </div>
            <!-- Niv√• 2: R√§tteg√•ngsrollerna -->
            <div id="level-2" data-level="2" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 locked relative">
                <span class="text-3xl mb-2">üèõÔ∏è</span>
                <p class="font-bold text-lg">R√§tteg√•ngsrollerna</p>
                <span id="level-progress-2" class="level-progress-display absolute top-2 right-2 text-sm font-bold bg-purple-600 text-white px-2 py-0.5 rounded-full">0%</span>
            </div>
            <!-- Niv√• 3: P√•f√∂ljderna -->
            <div id="level-3" data-level="3" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 locked relative">
                <span class="text-3xl mb-2">üîí</span>
                <p class="font-bold text-lg">P√•f√∂ljderna</p>
                <span id="level-progress-3" class="level-progress-display absolute top-2 right-2 text-sm font-bold bg-purple-600 text-white px-2 py-0.5 rounded-full">0%</span>
            </div>
            <!-- Niv√• 4: R√§ttss√§kerhet -->
            <div id="level-4" data-level="4" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 locked relative">
                <span class="text-3xl mb-2">‚öñÔ∏è</span>
                <p class="font-bold text-lg">R√§ttss√§kerhet</p>
                <span id="level-progress-4" class="level-progress-display absolute top-2 right-2 text-sm font-bold bg-purple-600 text-white px-2 py-0.5 rounded-full">0%</span>
            </div>
        </div>

        <!-- Progressf√§lt -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-white">Din Progress:</h2>
                <p id="progress-percent" class="text-xl font-bold text-purple-400">0%</p>
            </div>
            <div class="w-full bg-gray-600 rounded-full h-4">
                <div id="progress-bar" class="bg-purple-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-400 mt-1">0 av 4 niv√•er klarade</p>
            <div class="flex justify-center mt-6">
                <button onclick="resetGame()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                    B√∂rja om (Nollst√§ll)
                </button>
            </div>
        </div>
    </div>

    <!-- Spelomr√•de (d√∂ljs initialt) -->
    <div id="game-area" class="hidden space-y-4">
        <div class="flex justify-between">
            <button id="back-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                ‚Üê Tillbaka till Kartan
            </button>
            <button onclick="resetGame()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                B√∂rja om
            </button>
        </div>

        <!-- Fr√•gerubrik och text -->
        <div class="text-center pt-2">
            <h2 id="level-title" class="text-xl font-bold text-gray-400 mb-2"></h2>
            <p id="question-text" class="text-2xl md:text-3xl text-white font-extrabold"></p>
        </div>

        <!-- Quiz/Aktivitetskort -->
        <div id="quiz-container" class="bg-gray-700 p-6 rounded-xl shadow-2xl space-y-6">
            
            <div id="options-container" class="grid grid-cols-2 gap-4"> 
                <!-- Svarsalternativ genereras h√§r -->
            </div>
            <p id="feedback-message" class="text-center text-lg font-bold min-h-6"></p>
            <div id="next-button-container" class="flex justify-center">
                <button id="next-question-button" class="hidden bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition duration-200 shadow-md">
                    N√§sta fr√•ga
                </button>
            </div>
        </div>
        
        <!-- Samlade St√∂dord f√∂r Niv√•n -->
        <div id="stodord-display" class="bg-gray-700 p-4 rounded-xl border border-purple-500 mt-4">
            <h3 class="text-xl font-bold text-purple-400 mb-2">Samlade St√∂dord:</h3>
            <div id="current-stodord" class="text-gray-300 text-sm italic"></div>
        </div>
    </div>

    <!-- Slutsk√§rm -->
    <div id="end-screen" class="hidden text-center bg-gray-800 p-10 rounded-xl shadow-2xl">
        <h2 class="text-5xl font-black text-green-400 mb-4">GRATTIS! UPPDRAG KLARAT!</h2>
        <p class="text-2xl text-white mb-6">Du har nu stenkoll p√• r√§ttsprocessen inf√∂r provet!</p>
        <h3 class="text-2xl font-bold text-purple-400 mb-3">Din Prov-Sammanfattning:</h3>
        <div id="final-stodord" class="text-left bg-gray-700 p-6 rounded-lg text-gray-300 space-y-2">
            <!-- Alla st√∂dord listas h√§r -->
        </div>
        <button onclick="resetGame()" class="mt-8 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition duration-200 shadow-md">
            Spela igen
        </button>
    </div>
</div>

<script>
    // Funktion f√∂r att slumpa ordningen p√• en array (Fisher-Yates shuffle)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- Speldata: Fr√•gor och svar grupperade efter de nya kategorierna ---
    const gameData = [
        {
            id: 1,
            title: "F√∂runders√∂kning och √Öklagaren",
            questions: [
                {
                    question: "Vilken √§r Polisens huvuduppgift i en **f√∂runders√∂kning**?",
                    options: [
                        { text: "Leda r√§tteg√•ngen och d√∂ma den tilltalade.", isCorrect: false },
                        { text: "Samla bevis, h√•lla f√∂rh√∂r och anv√§nda tekniska metoder.", isCorrect: true, stodord: "üîç F√∂runders√∂kning: Samla bevis/h√•lla f√∂rh√∂r" },
                        { text: "Besluta om dagsb√∂ter baserat p√• inkomst.", isCorrect: false },
                        { text: "Pr√∂va √∂verklagade m√•l fr√•n tingsr√§tten.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad inneb√§r det n√§r √Öklagaren **v√§cker √•tal**?",
                    options: [
                        { text: "Att polisen p√•b√∂rjar en f√∂runders√∂kning.", isCorrect: false },
                        { text: "Att domaren best√§mmer sig f√∂r att h√§kta personen.", isCorrect: false },
                        { text: "Att bevisen bed√∂mts r√§cka f√∂r r√§tteg√•ng och den misst√§nkte blir tilltalad.", isCorrect: true, stodord: "üìÑ V√§cka √•tal: Misst√§nkt blir tilltalad" },
                        { text: "Att den tilltalade blir villkorligt frigiven.", isCorrect: false }
                    ]
                },
                {
                    question: "Varf√∂r beslutar **domstolen** om h√§ktning, ist√§llet f√∂r polisen eller √•klagaren?",
                    options: [
                        { text: "F√∂r att det kr√§vs en oberoende pr√∂vning av behovet av h√§ktning.", isCorrect: true, stodord: "üîê H√§ktning: Kr√§ver oberoende pr√∂vning av domstol" },
                        { text: "F√∂r att √•klagaren ska slippa ta ansvar.", isCorrect: false },
                        { text: "F√∂r att den h√§ktade ska f√• tr√§ffa sin f√∂rsvarsadvokat.", isCorrect: false },
                        { text: "Det h√§nder bara i m√•l som √§r prejudikat.", isCorrect: false }
                    ]
                }
            ]
        },
        {
            id: 2,
            title: "R√§tteg√•ngsrollerna",
            questions: [
                {
                    question: "Vad kallas den **f√∂rsta instansen** som pr√∂var brottm√•l och tvistem√•l?",
                    options: [
                        { text: "H√∂gsta domstolen (HD).", isCorrect: false },
                        { text: "Hovr√§tten.", isCorrect: false },
                        { text: "Tingsr√§tten.", isCorrect: true, stodord: "‚öñÔ∏è Tingsr√§tten: F√∂rsta instans (Brottm√•l och tvistem√•l)" },
                        { text: "√Öklagarmyndigheten.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad √§r **f√∂rsvarsadvokatens** fr√§msta uppgift i r√§tteg√•ngen?",
                    options: [
                        { text: "Avg√∂ra p√•f√∂ljden f√∂r den tilltalade.", isCorrect: false },
                        { text: "Hj√§lpa den tilltalade och se till att hen f√•r en r√§ttvis behandling.", isCorrect: true, stodord: "üéØ F√∂rsvarsadvokat: Ser till r√§ttvis behandling f√∂r tilltalad" },
                        { text: "Leda utredningen och samla bevis.", isCorrect: false },
                        { text: "F√• parterna i tvistem√•l att f√∂rlikas.", isCorrect: false }
                    ]
                },
                {
                    question: "Vilken roll har **n√§mndem√§nnen** i domstolen?",
                    options: [
                        { text: "De √§r utbildade jurister som leder r√§tteg√•ngen.", isCorrect: false },
                        { text: "De √§r vanliga medborgare som utses av politiska partier och d√∂mer tillsammans med domaren.", isCorrect: true, stodord: "üë• N√§mndem√§n: Vanliga medborgare som d√∂mer med domaren" },
                        { text: "De samlar in nya bevis till Hovr√§tten.", isCorrect: false },
                        { text: "De ansvarar f√∂r att vittnet talar sanning.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad kallas det n√§r ett **vittne ljuger** i domstolen?",
                    options: [
                        { text: "F√∂rlikning.", isCorrect: false },
                        { text: "Mened.", isCorrect: true, stodord: "‚ö†Ô∏è Mened: Allvarligt brott n√§r vittne ljuger" },
                        { text: "Pr√∂vningstillst√•nd.", isCorrect: false },
                        { text: "Villkorlig frigivning.", isCorrect: false }
                    ]
                }
            ]
        },
        {
            id: 3,
            title: "P√•f√∂ljderna",
            questions: [
                {
                    question: "Hur ber√§knas **dagsb√∂ter**?",
                    options: [
                        { text: "En fast summa oavsett inkomst.", isCorrect: false },
                        { text: "Antal dagar multiplicerat med ett belopp som beror p√• inkomst.", isCorrect: true, stodord: "üìä Dagsb√∂ter: Belopp anpassas efter inkomst (r√§ttvist)" },
                        { text: "Domaren slumpar fram en summa baserat p√• brottets allvar.", isCorrect: false },
                        { text: "Det √§r samma sak som villkorlig frigivning.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad inneb√§r **villkorlig frigivning** fr√•n ett f√§ngelsestraff?",
                    options: [
                        { text: "Att personen blir frigiven efter tv√• tredjedelar av strafftiden.", isCorrect: true, stodord: "‚è±Ô∏è Villkorlig frigivning: Efter 2/3 av f√§ngelsestraffet" },
                        { text: "Att personen f√•r fotboja f√∂r resten av livet.", isCorrect: false },
                        { text: "Att personen kan bli fri efter halva tiden.", isCorrect: false },
                        { text: "Att personen aldrig blir fri.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad √§r en nackdel med **f√§ngelse** som p√•f√∂ljd?",
                    options: [
                        { text: "Det skyddar inte samh√§llet tillr√§ckligt.", isCorrect: false },
                        { text: "Det kan g√∂ra √•teranpassning i samh√§llet sv√•rare.", isCorrect: true, stodord: "üëé F√§ngelse: Sv√•rt med √•teranpassning, men skyddar samh√§llet" },
                        { text: "Det √§r inte anpassat efter inkomst.", isCorrect: false },
                        { text: "Det ges endast vid tvistem√•l.", isCorrect: false }
                    ]
                },
                {
                    question: "Vilken typ av anstalt har **h√•rd bevakning** och begr√§nsad r√∂relsefrihet?",
                    options: [
                        { text: "√ñppen anstalt.", isCorrect: false },
                        { text: "Sluten anstalt.", isCorrect: true, stodord: "üîí Sluten anstalt: H√•rd bevakning (f√∂r allvarligare brott)" },
                        { text: "Kriminalv√•rdens centrum f√∂r f√∂rlikning.", isCorrect: false },
                        { text: "Friv√•rden.", isCorrect: false }
                    ]
                }
            ]
        },
        {
            id: 4,
            title: "R√§ttss√§kerhet",
            questions: [
                {
                    question: "Varf√∂r tar **H√∂gsta domstolen** (HD) bara upp m√•l som f√•tt pr√∂vningstillst√•nd?",
                    options: [
                        { text: "F√∂r att de m√•ste spara tid och bara pr√∂va nya bevis.", isCorrect: false },
                        { text: "F√∂r att de bara pr√∂var m√•l som √§r viktiga f√∂r hur lagar ska tolkas i framtiden (prejudikat).", isCorrect: true, stodord: "üé´ HD: Ger pr√∂vningstillst√•nd f√∂r v√§gledande fall (prejudikat)" },
                        { text: "Det √§r en del av principen 'Offentlighetsprincipen'.", isCorrect: false },
                        { text: "Eftersom de √§r f√∂rsta instans.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad inneb√§r principen **'Lika inf√∂r lagen'**?",
                    options: [
                        { text: "Alla ska d√∂mas till samma straff f√∂r samma brott.", isCorrect: false },
                        { text: "Ingen ska f√• f√∂rdelar eller nackdelar beroende p√• ekonomi, bakgrund eller grupptillh√∂righet.", isCorrect: true, stodord: "‚öñÔ∏è Lika inf√∂r lagen: Ingen diskriminering baserat p√• bakgrund" },
                        { text: "Endast jurister f√•r d√∂ma i domstol.", isCorrect: false },
                        { text: "Man f√•r √∂verklaga hur m√•nga g√•nger man vill.", isCorrect: false }
                    ]
                },
                {
                    question: "Hur bidrar **oberoende domstolar** och **offentliga r√§tteg√•ngar** till r√§ttss√§kerheten?",
                    options: [
                        { text: "Det skapar misstro i samh√§llet.", isCorrect: false },
                        { text: "Det minskar risken f√∂r maktmissbruk och l√•ter allm√§nheten granska domstolens arbete.", isCorrect: true, stodord: "üîç R√§ttss√§kerhet: √ñppna r√§tteg√•ngar minskar risk f√∂r maktmissbruk" },
                        { text: "Det ger domaren m√∂jlighet att v√§lja sina egna lagar.", isCorrect: false },
                        { text: "Det g√∂r att n√§mndem√§nnen kan utses av kungen.", isCorrect: false }
                    ]
                },
                {
                    question: "Varf√∂r √§r det viktigt att kunna **√∂verklaga** en dom?",
                    options: [
                        { text: "F√∂r att det kr√§vs nya bevis f√∂r att en dom ska √§ndras.", isCorrect: false },
                        { text: "F√∂r att en h√∂gre domstol kan granska domen och korrigera eventuella fel.", isCorrect: true, stodord: "üîÅ √ñverklaga: H√∂gre domstol granskar/korrigerar fel (r√§ttss√§kerhet)" },
                        { text: "Eftersom det bara √§r i Hovr√§tten som n√§mndem√§n deltar.", isCorrect: false },
                        { text: "Det g√§ller endast i tvistem√•l.", isCorrect: false }
                    ]
                }
            ]
        }
    ];
    // --- Slut p√• speldata ---

    // --- Globalt speltillst√•nd och element ---
    let gameState = {
        currentLevel: 1,
        levelProgress: 0,
        unlockedLevels: [1], // Niv√• 1 √§r alltid ol√•st
        stodord: [], // Samlade st√∂dord √∂ver alla niv√•er
        levelCompletion: {
            1: 0, 
            2: 0,
            3: 0,
            4: 0
        },
    };

    const app = document.getElementById('app');
    const mainScreen = document.getElementById('main-screen');
    const gameArea = document.getElementById('game-area');
    const endScreen = document.getElementById('end-screen');
    const levelSelection = document.getElementById('level-selection');
    const backButton = document.getElementById('back-button');
    const levelTitle = document.getElementById('level-title');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackMessage = document.getElementById('feedback-message');
    const nextQuestionButton = document.getElementById('next-question-button');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent');
    const currentStodordDisplay = document.getElementById('current-stodord');
    const finalStodordDisplay = document.getElementById('final-stodord');

    let currentQuestionIndex = 0;
    let currentLevelData = null;
    let levelStodord = [];
    let currentQuestionAnswered = false;
    // --- Slut p√• globalt speltillst√•nd och element ---

    // --- Funktioner f√∂r spelmekanik ---

    function updateLevelSelection() {
        const totalLevels = gameData.length;
        let clearedLevels = 0;
        
        levelSelection.querySelectorAll('.card').forEach(card => {
            const levelId = parseInt(card.dataset.level);
            const levelData = gameData.find(d => d.id === levelId);
            const totalQuestions = levelData.questions.length;
            const completedQuestions = gameState.levelCompletion[levelId] || 0;
            const levelPercentage = Math.round((completedQuestions / totalQuestions) * 100);

            const progressDisplay = card.querySelector(`#level-progress-${levelId}`);
            if (progressDisplay) {
                progressDisplay.textContent = `${levelPercentage}%`;
            }

            card.classList.remove('unlocked', 'locked', 'cleared-level');
            card.style.borderColor = ''; // √Öterst√§ll kantf√§rg
            
            // √Öterst√§ll klickhanteraren
            card.onclick = () => {};

            if (levelPercentage === 100) {
                clearedLevels++;
                card.classList.add('cleared-level');
                progressDisplay.classList.remove('bg-purple-600');
                progressDisplay.classList.add('bg-green-600');
                // G√∂r en klarad niv√• klickbar f√∂r repetition
                card.onclick = () => startLevel(levelId); 
            } else if (gameState.unlockedLevels.includes(levelId)) {
                // Niv√• √§r ol√•st men ej klar
                card.classList.add('unlocked');
                progressDisplay.classList.remove('bg-green-600');
                progressDisplay.classList.add('bg-purple-600');
                card.onclick = () => startLevel(levelId);
            } else {
                // Niv√• √§r l√•st
                card.classList.add('locked');
                progressDisplay.classList.remove('bg-green-600');
                progressDisplay.classList.add('bg-purple-600');
                // Eftersom pointer-events: none anv√§nds i CSS beh√∂ver vi inte s√§tta onclick f√∂r l√•sta kort
            }
        });

        const totalQuestionsAllLevels = gameData.reduce((sum, level) => sum + level.questions.length, 0);
        const completedQuestionsTotal = Object.values(gameState.levelCompletion).reduce((sum, count) => sum + count, 0);

        const totalPercentage = Math.round((completedQuestionsTotal / totalQuestionsAllLevels) * 100);

        progressBar.style.width = `${totalPercentage}%`;
        progressPercent.textContent = `${totalPercentage}%`; 
        progressText.textContent = `${clearedLevels} av ${totalLevels} niv√•er klarade`;


        if (clearedLevels === totalLevels) {
            showEndScreen();
        }
    }

    function startLevel(levelId) {
        currentLevelData = gameData.find(d => d.id === levelId);
        gameState.currentLevel = levelId;
        
        // Hitta den f√∂rsta fr√•gan som inte √§r klarad
        currentQuestionIndex = currentLevelData.questions.findIndex((q, index) => 
            (gameState.levelCompletion[levelId] || 0) <= index
        );

        // Om alla fr√•gor redan √§r klara, starta om fr√•n b√∂rjan
        if (currentQuestionIndex === -1) {
            currentQuestionIndex = 0;
        }

        // √Öterst√§ll st√∂dorden till de som redan har samlats in
        levelStodord = gameState.stodord.filter(s => 
            currentLevelData.questions.some(q => 
                q.options.find(o => o.isCorrect)?.stodord === s
            )
        );

        mainScreen.classList.add('hidden');
        gameArea.classList.remove('hidden');

        levelTitle.textContent = currentLevelData.title;
        loadQuestion();
        updateLevelStodord();
    }

    function loadQuestion() {
        if (currentQuestionIndex >= currentLevelData.questions.length) {
            levelComplete();
            return;
        }
        
        currentQuestionAnswered = false;

        const question = currentLevelData.questions[currentQuestionIndex];
        questionText.textContent = `Fr√•ga ${currentQuestionIndex + 1} av ${currentLevelData.questions.length}: ${question.question}`; 
        
        optionsContainer.innerHTML = '';
        feedbackMessage.textContent = '';
        nextQuestionButton.classList.add('hidden');

        // SLUMP MEKANISM: Slumpa ordningen p√• svarsalternativen
        const shuffledOptions = shuffleArray([...question.options]);

        shuffledOptions.forEach((option, index) => {
            const button = document.createElement('button');
            button.textContent = option.text;
            // L√§gg till min-h-[6rem] f√∂r b√§ttre mobilanpassning
            button.className = 'option-button card p-4 md:p-6 rounded-xl text-center text-lg md:text-xl font-bold text-gray-100 w-full transition duration-150 flex items-center justify-center min-h-[6rem]';
            button.onclick = () => checkAnswer(button, option, question.options);
            optionsContainer.appendChild(button);
        });
    }

    function checkAnswer(selectedButton, selectedOption, allOptions) {
        
        if (currentQuestionAnswered) {
             return;
        }
        currentQuestionAnswered = true; // F√∂rhindra dubbelklick

        if (selectedOption.isCorrect) {
            selectedButton.classList.add('correct-answer');
            feedbackMessage.textContent = 'R√§tt! Bra jobbat. Du har samlat ett st√∂dord!';
            
            // Inaktivera alla knappar
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);
            
            const currentLevelId = gameState.currentLevel;
            const currentLevelCompletedCount = gameState.levelCompletion[currentLevelId] || 0;
            
            // Endast √∂ka klarade fr√•gor om det √§r f√∂rsta g√•ngen fr√•gan besvaras korrekt
            if (currentQuestionIndex === currentLevelCompletedCount) { 
                gameState.levelCompletion[currentLevelId] = currentLevelCompletedCount + 1;
            }
            
            const totalQuestions = currentLevelData.questions.length;

            // Logik f√∂r att l√•sa upp n√§sta niv√•
            if (gameState.levelCompletion[currentLevelId] === totalQuestions) {
                const nextLevelId = currentLevelId + 1;
                if (nextLevelId <= gameData.length && !gameState.unlockedLevels.includes(nextLevelId)) {
                    gameState.unlockedLevels.push(nextLevelId);
                    // Visa meddelande om att ny niv√• √§r uppl√•st
                    showMessage(`Niv√• ${nextLevelId} uppl√•st: ${gameData.find(d => d.id === nextLevelId).title}`, 'text-purple-400');
                }
            }
            
            if (selectedOption.stodord && !gameState.stodord.includes(selectedOption.stodord)) {
                gameState.stodord.push(selectedOption.stodord);
                levelStodord.push(selectedOption.stodord);
                updateLevelStodord();
            }
            nextQuestionButton.classList.remove('hidden');
            nextQuestionButton.onclick = nextQuestion;
        } else {
            selectedButton.classList.add('wrong-answer');
            // F√∂r en fr√•ga som inte √§r r√§tt f√•r anv√§ndaren f√∂rs√∂ka igen
            currentQuestionAnswered = false; 
            feedbackMessage.textContent = 'Fel svar. Prova igen!';
            
            // Markera det korrekta svaret i r√∂tt tills anv√§ndaren klickar p√• det
            // S√§tt en kort timeout f√∂r animation, ta sedan bort fel f√§rg men l√•t knappen vara aktiv
            setTimeout(() => {
                selectedButton.classList.remove('wrong-answer');
            }, 300);
            
            nextQuestionButton.classList.add('hidden');
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        loadQuestion();
    }

    function levelComplete() {
        showMessage(`Niv√• ${gameState.currentLevel} klar!`, 'text-green-400');
        
        // Hitta n√§sta ol√•sta niv√• eller stanna p√• kartan
        setTimeout(() => {
            gameArea.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            updateLevelSelection();
        }, 1500);
    }

    function updateLevelStodord() {
        // Visa alla unika st√∂dord som samlats in under denna niv√•n.
        const currentLevelStodord = gameState.stodord.filter(s => 
            currentLevelData.questions.some(q => 
                q.options.find(o => o.isCorrect)?.stodord === s
            )
        );

        if (currentLevelStodord.length > 0) {
            currentStodordDisplay.innerHTML = currentLevelStodord.map(s => `<span class="inline-block bg-gray-600 rounded-full px-3 py-1 text-xs font-semibold text-purple-300 mr-2 mb-2">${s}</span>`).join('');
        } else {
            currentStodordDisplay.textContent = 'Inga st√∂dord samlade √§n...';
        }
    }

    function showMessage(msg, colorClass) {
        const notification = document.createElement('div');
        notification.textContent = msg;
        notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colorClass} bg-gray-800 p-3 rounded-xl shadow-lg z-50 transition-opacity duration-300`;
        app.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function showEndScreen() {
        mainScreen.classList.add('hidden');
        gameArea.classList.add('hidden');
        endScreen.classList.remove('hidden');

        const uniqueStodord = [...new Set(gameState.stodord)];

        if (uniqueStodord.length === 0) {
            finalStodordDisplay.innerHTML = '<p class="text-center italic text-red-400">Du m√•ste svara p√• fr√•gorna f√∂r att f√• en sammanfattning!</p>';
        } else {
            finalStodordDisplay.innerHTML = uniqueStodord.map(s => {
                return `<li class="p-2 border-b border-gray-600 last:border-b-0">${s}</li>`;
            }).join('');
        }
    }

    function resetGame() {
        gameState = {
            currentLevel: 1,
            levelProgress: 0,
            unlockedLevels: [1],
            stodord: [],
            levelCompletion: { 1: 0, 2: 0, 3: 0, 4: 0 },
        };
        endScreen.classList.add('hidden');
        gameArea.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        updateLevelSelection();
        showMessage('Spelet har startats om!', 'text-yellow-400');
    }

    backButton.addEventListener('click', () => {
        gameArea.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        updateLevelSelection();
    });

    // Ladda spelet vid sidans laddning
    window.onload = () => {
        updateLevelSelection();
    };

</script>

</body>
</html>

