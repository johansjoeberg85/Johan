<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√§ttsprocessen: Jakten p√• R√§ttvisan</title>
    <!-- Ladda Tailwind CSS f√∂r enkel och responsiv styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Anpassad bakgrund och font */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #030712 100%);
            color: #d1d5db;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Anpassad styling f√∂r kort och interaktiva element */
        .card {
            background-color: #374151;
            border: 2px solid #6b7280;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.5);
            border-color: #a78bfa; /* Lila hoverf√§rg */
        }
        .locked {
            filter: grayscale(80%);
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none; /* Inaktivera klick n√§r l√•st */
        }
        .unlocked {
            animation: pulse-border 1.5s infinite;
        }

        /* CSS-animation f√∂r att indikera ol√•st niv√• */
        @keyframes pulse-border {
            0% { border-color: #4b5563; }
            50% { border-color: #a78bfa; }
            100% { border-color: #4b5563; }
        }

        .correct-answer {
            background-color: #10b981; /* Gr√∂n f√∂r r√§tt svar */
            color: white;
            animation: flash-correct 0.5s ease-in-out;
        }
        .wrong-answer {
            background-color: #ef4444; /* R√∂d f√∂r fel svar */
            color: white;
            animation: shake 0.3s;
        }

        /* CSS-animationer */
        @keyframes flash-correct {
            0%, 100% { background-color: #10b981; }
            50% { background-color: #059669; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

<div id="app" class="p-4 md:p-8 w-full max-w-4xl">
    <!-- Huvudsk√§rm f√∂r spelet -->
    <div id="main-screen" class="space-y-6">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white text-center mb-6 drop-shadow-lg">
            R√§ttsprocessen: Jakten p√• R√§ttvisan
        </h1>
        <p class="text-center text-lg md:text-xl text-gray-300 mb-8">
            V√§lkommen! Klicka p√• byggnaderna f√∂r att l√•sa upp kunskapen inf√∂r provet.
        </p>

        <!-- Niv√•v√§ljare (Klickbara kort) -->
        <div id="level-selection" class="grid grid-cols-2 gap-4 md:grid-cols-4 md:gap-6">
            <!-- Niv√• 1: Polisstationen -->
            <div id="level-1" data-level="1" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 unlocked">
                <span class="text-3xl mb-2">üö®</span>
                <p class="font-bold text-lg">1. Polisstationen</p>
                <p class="text-xs text-gray-400">F√∂runders√∂kning & √Öklagaren</p>
            </div>
            <!-- Niv√• 2: Tingshuset -->
            <div id="level-2" data-level="2" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 locked">
                <span class="text-3xl mb-2">üèõÔ∏è</span>
                <p class="font-bold text-lg">2. Tingshuset</p>
                <p class="text-xs text-gray-400">R√§tteg√•ngsrollerna</p>
            </div>
            <!-- Niv√• 3: F√§ngelset -->
            <div id="level-3" data-level="3" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 locked">
                <span class="text-3xl mb-2">üîí</span>
                <p class="font-bold text-lg">3. Kriminalv√•rden</p>
                <p class="text-xs text-gray-400">P√•f√∂ljderna</p>
            </div>
            <!-- Niv√• 4: H√∂gsta Tornet -->
            <div id="level-4" data-level="4" class="card p-4 rounded-xl text-center flex flex-col items-center justify-center h-40 locked">
                <span class="text-3xl mb-2">‚öñÔ∏è</span>
                <p class="font-bold text-lg">4. H√∂gsta Tornet</p>
                <p class="text-xs text-gray-400">R√§ttss√§kerhet</p>
            </div>
        </div>

        <!-- Progressf√§lt (Uppdaterad f√∂r att visa procent bredvid) -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-white">Din Progres:</h2>
                <p id="progress-percent" class="text-xl font-bold text-purple-400">0%</p> <!-- Nytt element f√∂r procent -->
            </div>
            <div class="w-full bg-gray-600 rounded-full h-4">
                <div id="progress-bar" class="bg-purple-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-400 mt-1">0 av 4 niv√•er klarade</p>
        </div>
    </div>

    <!-- Spelomr√•de (d√∂ljs initialt) -->
    <div id="game-area" class="hidden space-y-4">
        <button id="back-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
            ‚Üê Tillbaka till Kartan
        </button>

        <!-- Fr√•gerubrik och text (justerad f√∂r att fokusera p√• fr√•gan) -->
        <div class="text-center pt-2">
            <h2 id="level-title" class="text-xl font-bold text-gray-400 mb-2"></h2> <!-- Rubriken mindre -->
            <p id="question-text" class="text-2xl md:text-3xl text-white font-extrabold"></p> <!-- Fr√•getexten st√∂rre och fetare -->
        </div>

        <!-- Quiz/Aktivitetskort -->
        <div id="quiz-container" class="bg-gray-700 p-6 rounded-xl shadow-2xl space-y-6">
            
            <!-- √Ñndrat till grid-cols-2 f√∂r att tvinga fram 2x2 layout √§ven p√• mobil -->
            <div id="options-container" class="grid grid-cols-2 gap-4"> 
                <!-- Svarsalternativ genereras h√§r -->
            </div>
            <p id="feedback-message" class="text-center text-lg font-bold min-h-6"></p>
            <div id="next-button-container" class="flex justify-center">
                <button id="next-question-button" class="hidden bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition duration-200 shadow-md">
                    N√§sta fr√•ga
                </button>
            </div>
        </div>
        
        <!-- Samlade St√∂dord f√∂r Niv√•n -->
        <div id="stodord-display" class="bg-gray-700 p-4 rounded-xl border border-purple-500 mt-4">
            <h3 class="text-xl font-bold text-purple-400 mb-2">Samlade St√∂dord:</h3>
            <div id="current-stodord" class="text-gray-300 text-sm italic"></div>
        </div>
    </div>

    <!-- Slutsk√§rm -->
    <div id="end-screen" class="hidden text-center bg-gray-800 p-10 rounded-xl shadow-2xl">
        <h2 class="text-5xl font-black text-green-400 mb-4">GRATTIS! UPPDRAG KLARAT!</h2>
        <p class="text-2xl text-white mb-6">Du har nu stenkoll p√• r√§ttsprocessen inf√∂r provet!</p>
        <h3 class="text-2xl font-bold text-purple-400 mb-3">Din Prov-Sammanfattning:</h3>
        <div id="final-stodord" class="text-left bg-gray-700 p-6 rounded-lg text-gray-300 space-y-2">
            <!-- Alla st√∂dord listas h√§r -->
        </div>
        <button onclick="resetGame()" class="mt-8 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition duration-200 shadow-md">
            Spela igen
        </button>
    </div>
</div>

<script>
    // Globala variabler f√∂r spelets tillst√•nd
    let gameState = {
        currentLevel: 1,
        levelProgress: 0,
        unlockedLevels: [1],
        stodord: [], // Samlade st√∂dord
    };

    // Data f√∂r spelets niv√•er, baserat p√• det angivna materialet
    const gameData = [
        // Niv√• 1: Polisstationen - F√∂runders√∂kning & √Öklagaren (3 fr√•gor)
        {
            id: 1,
            title: "1. Polisstationen: F√∂runders√∂kningen",
            questions: [
                {
                    question: "Vilken av dessa √§r en central uppgift f√∂r **Polisen** i en f√∂runders√∂kning?",
                    options: [
                        { text: "Leda r√§tteg√•ngen och d√∂ma den tilltalade.", isCorrect: false },
                        { text: "Samla bevis, h√•lla f√∂rh√∂r och anv√§nda tekniska metoder.", isCorrect: true, stodord: "üîç f√∂runders√∂kning, üß™ bevis, üó£Ô∏è f√∂rh√∂r, ‚ö†Ô∏è Kan l√§ggas ner" },
                        { text: "Besluta om dagsb√∂ter baserat p√• inkomst.", isCorrect: false },
                        { text: "Pr√∂va √∂verklagade m√•l fr√•n tingsr√§tten.", isCorrect: false }
                    ]
                },
                {
                    question: "Vilken roll har **√Öklagaren** n√§r bevisen √§r tillr√§ckligt starka f√∂r r√§tteg√•ng?",
                    options: [
                        { text: "Beg√§ra f√∂rlikning med den tilltalade.", isCorrect: false },
                        { text: "Avg√∂ra om den tilltalade f√•r fotboja.", isCorrect: false },
                        { text: "V√§cka √•tal och skriva en skriftlig anklagelse.", isCorrect: true, stodord: "‚õìÔ∏è Beslutar om anh√•llan, üîê beg√§r h√§ktning, üìÑ v√§cker √•tal" },
                        { text: "Utse n√§mndem√§n till domstolen.", isCorrect: false }
                    ]
                },
                {
                    question: "N√§r blir en **misst√§nkt** officiellt en **tilltalad**?",
                    options: [
                        { text: "N√§r polisen p√•b√∂rjar en f√∂runders√∂kning.", isCorrect: false },
                        { text: "N√§r domaren best√§mmer sig f√∂r att h√§kta personen.", isCorrect: false },
                        { text: "N√§r √•klagaren v√§cker √•tal.", isCorrect: true, stodord: "üìÑ N√§r √•klagaren v√§cker √•tal, ‚úîÔ∏è utredning √§r klar" },
                        { text: "Efter att personen avtj√§nat tv√• tredjedelar av straffet.", isCorrect: false }
                    ]
                }
            ]
        },
        // Niv√• 2: Tingshuset - R√§tteg√•ngsrollerna (4 fr√•gor)
        {
            id: 2,
            title: "2. Tingshuset: R√§tteg√•ngshj√§ltarna",
            questions: [
                {
                    question: "Vilken domstol √§r **f√∂rsta instans** och pr√∂var b√•de brottm√•l och tvistem√•l?",
                    options: [
                        { text: "H√∂gsta domstolen.", isCorrect: false },
                        { text: "Hovr√§tten.", isCorrect: false },
                        { text: "Tingsr√§tten.", isCorrect: true, stodord: "‚öñÔ∏è f√∂rsta instans, üîÅ √∂verklagade m√•l, üìò HD: hur lagar ska tolkas" },
                        { text: "√Öklagarmyndigheten.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad √§r **f√∂rsvarsadvokatens** fr√§msta uppgift i r√§tteg√•ngen?",
                    options: [
                        { text: "Avg√∂ra p√•f√∂ljden f√∂r den tilltalade.", isCorrect: false },
                        { text: "Leda utredningen och samla bevis.", isCorrect: false },
                        { text: "Hj√§lpa den tilltalade och se till att hen f√•r en r√§ttvis behandling.", isCorrect: true, stodord: "üéØ hj√§lper den tilltalade, ‚öñÔ∏è ser till r√§ttvis behandling" },
                        { text: "F√∂rs√∂ka f√• parterna i tvistem√•l att f√∂rlikas.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad kallas det n√§r ett **vittne** ljuger i domstolen, och varf√∂r √§r det allvarligt?",
                    options: [
                        { text: "Oberoende pr√∂vning, det g√∂r processen l√§ngre.", isCorrect: false },
                        { text: "F√∂rlikning, det p√•verkar bara tvistem√•l.", isCorrect: false },
                        { text: "Mened, det √§r allvarligt eftersom det kan p√•verka domslutet.", isCorrect: true, stodord: "üëÅÔ∏è vittne m√•ste tala sanning, ‚ö†Ô∏è mened √§r att ljuga" },
                        { text: "Pr√∂vningstillst√•nd, det kr√§vs i H√∂gsta domstolen.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad √§r den huvudsakliga skillnaden mellan ett **brottm√•l** och ett **tvistem√•l**?",
                    options: [
                        { text: "Brottm√•l pr√∂vas i Hovr√§tten, tvistem√•l i Tingsr√§tten.", isCorrect: false },
                        { text: "Brottm√•l handlar om brott (t.ex. st√∂ld), tvistem√•l om oenighet (t.ex. avtal/pengar).", isCorrect: true, stodord: "üöî brottm√•l g√§ller brott, üí¨ tvistem√•l √§r oenighet" },
                        { text: "I brottm√•l s√∂ker domaren f√∂rlikning, i tvistem√•l inte.", isCorrect: false },
                        { text: "Brottm√•l har alltid n√§mndem√§n, tvistem√•l aldrig.", isCorrect: false }
                    ]
                }
            ]
        },
        // Niv√• 3: Kriminalv√•rden - P√•f√∂ljderna (4 fr√•gor)
        {
            id: 3,
            title: "3. Kriminalv√•rden: P√•f√∂ljdsanalys",
            questions: [
                {
                    question: "Hur ber√§knas **dagsb√∂ter** f√∂r att g√∂ra straffet mer r√§ttvist?",
                    options: [
                        { text: "En fast summa oavsett inkomst.", isCorrect: false },
                        { text: "Antal dagar multiplicerat med ett belopp som beror p√• inkomst.", isCorrect: true, stodord: "üí∞ b√∂ter √§r fast summa, üìÖ dagsb√∂ter, üìä dagsbelopp beror p√• inkomst" },
                        { text: "Domaren slumpar fram en summa baserat p√• brottets allvar.", isCorrect: false },
                        { text: "Det √§r det samma som villkorlig frigivning.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad inneb√§r det att bli **villkorligt frigiven** fr√•n ett f√§ngelsestraff?",
                    options: [
                        { text: "Att personen aldrig blir fri.", isCorrect: false },
                        { text: "Att personen blir frigiven efter halva tiden.", isCorrect: false },
                        { text: "Att personen kan bli fri efter tv√• tredjedelar av strafftiden.", isCorrect: true, stodord: "üîê Inl√•st, ‚è±Ô∏è villkorligt frigiven 2/3 av tid" },
                        { text: "Att personen f√•r fotboja f√∂r resten av livet.", isCorrect: false }
                    ]
                },
                {
                    question: "Vilken typ av anstalt har **h√•rd bevakning** och anpassas efter allvarligare brott?",
                    options: [
                        { text: "√ñppen anstalt.", isCorrect: false },
                        { text: "Sluten anstalt.", isCorrect: true, stodord: "üö™ √∂ppna anstalter, üîí slutna anstalter har h√•rd bevakning" },
                        { text: "Anstalten f√∂r tvistem√•l.", isCorrect: false },
                        { text: "Kriminalv√•rdens centrum f√∂r f√∂rlikning.", isCorrect: false }
                    ]
                },
                {
                    question: "Vilken p√•f√∂ljd **skyddar samh√§llet** mest, men kan g√∂ra √•teranpassning sv√•rare?",
                    options: [
                        { text: "B√∂ter.", isCorrect: false },
                        { text: "Fotboja.", isCorrect: false },
                        { text: "F√§ngelse.", isCorrect: true, stodord: "üîê f√§ngelse skyddar samh√§llet, üì° fotboja ger mer frihet" },
                        { text: "Samh√§llstj√§nst.", isCorrect: false }
                    ]
                }
            ]
        },
        // Niv√• 4: H√∂gsta Tornet - R√§ttss√§kerhet (3 fr√•gor)
        {
            id: 4,
            title: "4. H√∂gsta Tornet: R√§ttss√§kerheten",
            questions: [
                {
                    question: "Varf√∂r tar **H√∂gsta domstolen** (HD) bara upp m√•l som f√•tt pr√∂vningstillst√•nd?",
                    options: [
                        { text: "F√∂r att de m√•ste spara tid.", isCorrect: false },
                        { text: "F√∂r att de bara pr√∂var m√•l som √§r viktiga f√∂r hur lagar ska tolkas i framtiden (v√§gledande).", isCorrect: true, stodord: "üé´ Pr√∂vningstillst√•nd, üß≠ V√§gledande f√∂r hur lagar ska tolkas" },
                        { text: "Eftersom det kr√§vs nya bevis i HD.", isCorrect: false },
                        { text: "Det √§r en del av principen 'Lika inf√∂r lagen'.", isCorrect: false }
                    ]
                },
                {
                    question: "Vad inneb√§r principen **'Lika inf√∂r lagen'**?",
                    options: [
                        { text: "Alla ska d√∂mas till samma straff f√∂r samma brott.", isCorrect: false },
                        { text: "Ingen ska f√• f√∂rdelar eller nackdelar beroende p√• ekonomi eller bakgrund.", isCorrect: true, stodord: "‚öñÔ∏è alla behandlas lika, üö´ inga f√∂rdelar eller nackdelar" },
                        { text: "Endast jurister f√•r d√∂ma i domstol.", isCorrect: false },
                        { text: "Man f√•r √∂verklaga hur m√•nga g√•nger man vill.", isCorrect: false }
                    ]
                },
                {
                    question: "Hur bidrar **oberoende domstolar** och **offentliga r√§tteg√•ngar** till r√§ttss√§kerheten?",
                    options: [
                        { text: "Det skapar misstro i samh√§llet.", isCorrect: false },
                        { text: "Det ger domaren m√∂jlighet att v√§lja sina egna lagar.", isCorrect: false },
                        { text: "Det minskar risken f√∂r maktmissbruk och l√•ter allm√§nheten granska domstolens arbete.", isCorrect: true, stodord: "‚úîÔ∏è r√§ttss√§kerheten √∂kar, üèõÔ∏è domstolarna √§r oberoende, üîç √∂ppna r√§tteg√•ngar" },
                        { text: "Det g√∂r att n√§mndem√§nnen utses av kungen.", isCorrect: false }
                    ]
                }
            ]
        }
    ];

    // --- DOM-element ---
    const app = document.getElementById('app');
    const mainScreen = document.getElementById('main-screen');
    const gameArea = document.getElementById('game-area');
    const endScreen = document.getElementById('end-screen');
    const levelSelection = document.getElementById('level-selection');
    const backButton = document.getElementById('back-button');
    const levelTitle = document.getElementById('level-title');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackMessage = document.getElementById('feedback-message');
    const nextQuestionButton = document.getElementById('next-question-button');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent'); // Nytt element
    const currentStodordDisplay = document.getElementById('current-stodord');
    const finalStodordDisplay = document.getElementById('final-stodord');

    let currentQuestionIndex = 0;
    let currentLevelData = null;
    let levelStodord = []; // St√∂dord som samlas under nuvarande niv√•

    // --- Funktioner f√∂r spellogik ---

    /**
     * Uppdaterar UI f√∂r niv√•valet (l√•ser/l√•ser upp)
     */
    function updateLevelSelection() {
        // R√§kna ut progressionen
        const totalLevels = gameData.length;
        // Vi r√§knar en niv√• som "klarad" om n√§sta niv√• √§r ol√•st, eller om sista niv√•n √§r ol√•st.
        // clearedLevels √§r antalet KLARADE niv√•er.
        let clearedLevels = 0;
        for (let i = 1; i <= totalLevels; i++) {
            // Om n√§sta niv√• (i + 1) √§r ol√•st, betyder det att niv√• (i) √§r klar.
            // Sista niv√•n √§r klar om den √§r ol√•st.
            if (i < totalLevels && gameState.unlockedLevels.includes(i + 1)) {
                clearedLevels++;
            } else if (i === totalLevels && gameState.unlockedLevels.length === totalLevels) {
                // Sista niv√•n (Niv√• 4) √§r klar om alla √§r ol√•sta
                clearedLevels = totalLevels;
            } else if (i <= totalLevels && i < gameState.currentLevel) {
                 // Om man har klickat Tillbaka till kartan innan en niv√• √§r klar.
                 // Detta √§r ett litet fusk eftersom vi bara l√•ser upp n√§sta niv√• vid levelComplete().
            }
        }

        // Fix f√∂r att s√§kerst√§lla att clearedLevels inte g√•r √∂ver totalLevels (om spelaren √§r p√• Niv√• 4)
        if (gameState.unlockedLevels.length > clearedLevels) {
            clearedLevels = gameState.unlockedLevels.length - 1;
            if (clearedLevels > totalLevels) clearedLevels = totalLevels;
        }


        const percentage = (clearedLevels / totalLevels) * 100;
        
        progressBar.style.width = `${percentage}%`;
        progressPercent.textContent = `${Math.round(percentage)}%`; // Uppdaterat procentvisning
        progressText.textContent = `${clearedLevels} av ${totalLevels} niv√•er klarade`; // Uppdaterad text

        // G√• igenom alla niv√•kort
        levelSelection.querySelectorAll('.card').forEach(card => {
            const levelId = parseInt(card.dataset.level);
            
            // Hantera l√•sta/ol√•sta kort
            if (gameState.unlockedLevels.includes(levelId)) {
                card.classList.remove('locked');
                card.classList.add('unlocked');
                card.onclick = () => startLevel(levelId);
                
                // Om niv√•n √§r klar (dvs. n√§sta niv√• √§r ol√•st eller sista niv√•n √§r klar)
                // En niv√• √§r klar om n√§sta niv√• √§r ol√•st. Eller om det √§r sista niv√•n och spelet √§r slut.
                const isCleared = gameState.unlockedLevels.includes(levelId + 1) || (levelId === totalLevels && clearedLevels === totalLevels);

                if (isCleared) {
                    card.classList.remove('unlocked');
                    card.style.borderColor = '#10b981'; // Gr√∂n f√§rg f√∂r klarad niv√•
                    card.onclick = () => showMessage('Denna niv√• √§r redan klar. Prova en annan!', 'text-yellow-400');
                } else {
                     card.classList.remove('unlocked');
                     card.classList.add('unlocked');
                }

            } else {
                card.classList.add('locked');
                card.classList.remove('unlocked');
                card.onclick = () => showMessage('Du m√•ste klara f√∂reg√•ende niv√• f√∂rst!', 'text-red-400');
            }
        });

        // Kontrollera om spelet √§r slut
        if (clearedLevels === totalLevels) {
            showEndScreen();
        }
    }

    /**
     * Startar en specifik niv√• baserat p√• ID.
     * @param {number} levelId 
     */
    function startLevel(levelId) {
        currentLevelData = gameData.find(d => d.id === levelId);
        gameState.currentLevel = levelId;
        currentQuestionIndex = 0;
        levelStodord = [];

        // V√§xla vy
        mainScreen.classList.add('hidden');
        gameArea.classList.remove('hidden');

        // F√∂rb√§ttrat fokus: levelTitle √§r mindre, questionText √§r st√∂rre
        levelTitle.textContent = currentLevelData.title;
        loadQuestion();
        updateLevelStodord();
    }

    /**
     * Laddar n√§sta fr√•ga i niv√•n.
     */
    function loadQuestion() {
        // Kontrollera om niv√•n √§r klar
        if (currentQuestionIndex >= currentLevelData.questions.length) {
            levelComplete();
            return;
        }

        const question = currentLevelData.questions[currentQuestionIndex];
        // Tar bort den repetitiva rubriken fr√•n fr√•gan, eftersom levelTitle redan visar den
        questionText.textContent = `${question.question}`; 
        
        // √Öterst√§ll UI
        optionsContainer.innerHTML = '';
        feedbackMessage.textContent = '';
        nextQuestionButton.classList.add('hidden');

        // Ladda svarsalternativ
        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.textContent = option.text;
            // UPPDATERAT: Anv√§nder flex-grow f√∂r att tvinga knapparna att fylla hela det tillg√§ngliga utrymmet
            button.className = 'option-button card p-4 md:p-6 rounded-xl text-center text-lg md:text-xl font-bold text-gray-100 w-full transition duration-150 flex items-center justify-center min-h-[8rem]'; // Min-h√∂jd tillagd f√∂r b√§ttre utseende
            button.onclick = () => checkAnswer(button, option, question.options);
            optionsContainer.appendChild(button);
        });
    }

    /**
     * Kontrollerar om svaret √§r korrekt.
     * @param {HTMLElement} selectedButton - Knappen anv√§ndaren klickade p√•.
     * @param {object} selectedOption - Svarsalternativet.
     * @param {Array<object>} allOptions - Alla alternativ f√∂r fr√•gan.
     */
    function checkAnswer(selectedButton, selectedOption, allOptions) {
        // F√∂rhindra fler klick p√• alternativ
        optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);

        if (selectedOption.isCorrect) {
            // R√§tt svar
            selectedButton.classList.add('correct-answer');
            feedbackMessage.textContent = 'R√§tt! Bra jobbat.';
            
            // L√§gg till st√∂dord och uppdatera displayen
            if (selectedOption.stodord) {
                levelStodord.push(selectedOption.stodord);
                updateLevelStodord();
            }
            nextQuestionButton.classList.remove('hidden');
            nextQuestionButton.onclick = nextQuestion;
        } else {
            // Fel svar
            selectedButton.classList.add('wrong-answer');
            feedbackMessage.textContent = 'Fel svar. F√∂rs√∂k igen!';
            
            // Hitta och visa det korrekta svaret
            const correctAnswer = allOptions.find(opt => opt.isCorrect);
            optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                if (btn.textContent === correctAnswer.text) {
                    btn.classList.add('correct-answer');
                    // Visa korrekt svar men l√•t anv√§ndaren klicka p√• N√§sta
                }
            });
            nextQuestionButton.classList.remove('hidden');
            nextQuestionButton.onclick = nextQuestion; // L√•t anv√§ndaren g√• vidare trots fel
        }
    }

    /**
     * G√•r till n√§sta fr√•ga i sekvensen.
     */
    function nextQuestion() {
        currentQuestionIndex++;
        loadQuestion();
    }

    /**
     * Hanterar n√§r en niv√• √§r klar.
     */
    function levelComplete() {
        showMessage(`Niv√• ${gameState.currentLevel} klar!`, 'text-green-400');
        
        // L√§gg till de samlade st√∂dorden till det globala tillst√•ndet
        gameState.stodord = gameState.stodord.concat(levelStodord);

        // L√•s upp n√§sta niv√•
        const nextLevelId = gameState.currentLevel + 1;
        if (nextLevelId <= gameData.length && !gameState.unlockedLevels.includes(nextLevelId)) {
            gameState.unlockedLevels.push(nextLevelId);
            showMessage(`Du l√•ste upp Niv√• ${nextLevelId}!`, 'text-purple-400');
        }

        // √Öterg√• till huvudmenyn efter en kort f√∂rdr√∂jning
        setTimeout(() => {
            gameArea.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            updateLevelSelection();
        }, 1500);
    }

    /**
     * Uppdaterar visningen av st√∂dorden f√∂r den aktuella niv√•n.
     */
    function updateLevelStodord() {
        if (levelStodord.length > 0) {
            currentStodordDisplay.innerHTML = levelStodord.map(s => `<span class="inline-block bg-gray-600 rounded-full px-3 py-1 text-xs font-semibold text-purple-300 mr-2 mb-2">${s}</span>`).join('');
        } else {
            currentStodordDisplay.textContent = 'Inga st√∂dord samlade √§n...';
        }
    }

    /**
     * Visar ett meddelande i feedback-f√§ltet (anv√§nds f√∂r l√•sta niv√•er etc.).
     * @param {string} msg 
     * @param {string} colorClass 
     */
    function showMessage(msg, colorClass) {
        // Enkel meddelandebox, visas kortvarigt i huvudmenyn
        const notification = document.createElement('div');
        notification.textContent = msg;
        notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colorClass} bg-gray-800 p-3 rounded-xl shadow-lg z-50 transition-opacity duration-300`;
        app.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    /**
     * Visar slutsk√§rmen och sammanfattar alla st√∂dord.
     */
    function showEndScreen() {
        mainScreen.classList.add('hidden');
        gameArea.classList.add('hidden');
        endScreen.classList.remove('hidden');

        // Ta bort dubbletter av st√∂dord och formatera listan
        const uniqueStodord = [...new Set(gameState.stodord)];

        finalStodordDisplay.innerHTML = uniqueStodord.map(s => {
            // G√∂r st√∂dorden lite snyggare i listan
            return `<li class="p-2 border-b border-gray-600 last:border-b-0">${s}</li>`;
        }).join('');
    }

    /**
     * √Öterst√§ller spelets tillst√•nd.
     */
    function resetGame() {
        gameState = {
            currentLevel: 1,
            levelProgress: 0,
            unlockedLevels: [1],
            stodord: [],
        };
        endScreen.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        updateLevelSelection();
    }

    // --- Event Listeners ---
    backButton.addEventListener('click', () => {
        gameArea.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        updateLevelSelection(); // Uppdatera utseendet p√• huvudmenyn
    });

    // Initialisera spelet n√§r sidan laddas
    window.onload = () => {
        updateLevelSelection();
    };

</script>

</body>
</html>
